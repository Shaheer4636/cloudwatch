cat > apm_ingestion_dashboard.json <<'JSON'
{
  "widgets": [
    {
      "type": "text", "x": 0, "y": 0, "width": 24, "height": 4,
      "properties": {
        "markdown": "# APM Ingestion Reasons Overview (CloudWatch)\n**Source signal expected:** `Custom/APM` â†’ `IngestedBytes`\n**Dimensions:** `Env`, `Service`, `IngestionReason` (auto, rule, manual, error, rare, analytics, synthetics, synthetics-browser, rum, xray, lambda, appsec, unknown)\n\n> This dashboard reproduces the Datadog view with CloudWatch-supported widgets. Sunburst/treemap/tables and calendar shift are replaced with stacked charts and single-value tiles."
      }
    },

    /* ======= OVERVIEW ======= */
    { "type": "text", "x": 0, "y": 4, "width": 24, "height": 2,
      "properties": { "markdown": "## Overview by Env and Service" } },

    /* Total ingested bytes (all reasons) */
    {
      "type": "metric", "x": 0, "y": 6, "width": 6, "height": 6,
      "properties": {
        "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300,
        "title": "Total Ingested Bytes (All Reasons)",
        "metrics": [
          [ "Custom/APM", "IngestedBytes", { "id": "total_all", "label": "Total" } ]
        ]
      }
    },

    /* Ingested bytes by reason over time (stack replacement for sunburst/bars) */
    {
      "type": "metric", "x": 6, "y": 6, "width": 18, "height": 10,
      "properties": {
        "region": "us-east-1", "view": "timeSeries", "stat": "Sum", "stacked": true, "period": 300,
        "title": "Ingested Bytes by IngestionReason (stacked)",
        "legend": { "position": "right" },
        "metrics": [
          [ "Custom/APM", "IngestedBytes", "IngestionReason", "auto", { "id": "auto" } ],
          [ ".", ".", "IngestionReason", "rule", { "id": "rule" } ],
          [ ".", ".", "IngestionReason", "manual", { "id": "manual" } ],
          [ ".", ".", "IngestionReason", "error", { "id": "error" } ],
          [ ".", ".", "IngestionReason", "rare", { "id": "rare" } ],
          [ ".", ".", "IngestionReason", "analytics", { "id": "analytics" } ],
          [ ".", ".", "IngestionReason", "synthetics", { "id": "synthetics" } ],
          [ ".", ".", "IngestionReason", "synthetics-browser", { "id": "synth_browser" } ],
          [ ".", ".", "IngestionReason", "rum", { "id": "rum" } ],
          [ ".", ".", "IngestionReason", "xray", { "id": "xray" } ],
          [ ".", ".", "IngestionReason", "lambda", { "id": "lambda" } ],
          [ ".", ".", "IngestionReason", "appsec", { "id": "appsec" } ],
          [ ".", ".", "IngestionReason", "unknown", { "id": "unknown" } ]
        ]
      }
    },

    /* Contribution to overall volume over time (percent per reason) */
    {
      "type": "metric", "x": 0, "y": 12, "width": 24, "height": 10,
      "properties": {
        "region": "us-east-1", "view": "timeSeries", "stat": "Sum", "period": 300,
        "title": "Ingestion Reasons Contribution (%)",
        "legend": { "position": "right" },
        "metrics": [
          [ "Custom/APM", "IngestedBytes", { "id": "t", "visible": false } ],
          [ ".", ".", "IngestionReason", "auto", { "id": "a", "visible": false } ],
          [ ".", ".", "IngestionReason", "rule", { "id": "r", "visible": false } ],
          [ ".", ".", "IngestionReason", "manual", { "id": "m", "visible": false } ],
          [ ".", ".", "IngestionReason", "error", { "id": "e", "visible": false } ],
          [ ".", ".", "IngestionReason", "rare", { "id": "rr", "visible": false } ],
          [ ".", ".", "IngestionReason", "analytics", { "id": "an", "visible": false } ],
          [ ".", ".", "IngestionReason", "synthetics", { "id": "sy", "visible": false } ],
          [ ".", ".", "IngestionReason", "synthetics-browser", { "id": "sb", "visible": false } ],
          [ ".", ".", "IngestionReason", "rum", { "id": "ru", "visible": false } ],
          [ ".", ".", "IngestionReason", "xray", { "id": "xr", "visible": false } ],
          [ ".", ".", "IngestionReason", "lambda", { "id": "la", "visible": false } ],
          [ ".", ".", "IngestionReason", "appsec", { "id": "ap", "visible": false } ],
          [ ".", ".", "IngestionReason", "unknown", { "id": "un", "visible": false } ],
          [ { "expression": "100*a/t", "label": "Auto %", "id": "ea" } ],
          [ { "expression": "100*r/t", "label": "Rule %", "id": "er" } ],
          [ { "expression": "100*m/t", "label": "Manual %", "id": "em" } ],
          [ { "expression": "100*e/t", "label": "Error %", "id": "ee" } ],
          [ { "expression": "100*rr/t", "label": "Rare %", "id": "err" } ],
          [ { "expression": "100*an/t", "label": "Analytics %", "id": "ean" } ],
          [ { "expression": "100*sy/t", "label": "Synthetics %", "id": "esy" } ],
          [ { "expression": "100*sb/t", "label": "Synthetics-browser %", "id": "esb" } ],
          [ { "expression": "100*ru/t", "label": "RUM %", "id": "eru" } ],
          [ { "expression": "100*xr/t", "label": "X-Ray %", "id": "exr" } ],
          [ { "expression": "100*la/t", "label": "Lambda %", "id": "ela" } ],
          [ { "expression": "100*ap/t", "label": "AppSec %", "id": "eap" } ],
          [ { "expression": "100*un/t", "label": "Unknown %", "id": "eun" } ]
        ]
      }
    },

    /* ======= HEAD-BASED SAMPLING (auto + rule) ======= */
    { "type": "text", "x": 0, "y": 22, "width": 24, "height": 3,
      "properties": { "markdown": "## Head-based sampling (auto + rule)\nEquivalent to Datadog note and KPIs." } },

    /* Span volume (auto+rule) */
    {
      "type": "metric", "x": 0, "y": 25, "width": 6, "height": 6,
      "properties": {
        "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300,
        "title": "Span volume (auto + rule)",
        "metrics": [
          [ "Custom/APM", "IngestedBytes", "IngestionReason", "auto", { "id": "ha" } ],
          [ ".", ".", "IngestionReason", "rule", { "id": "hr" } ],
          [ { "expression": "ha+hr", "label": "auto+rule", "id": "h_sum" } ]
        ]
      }
    },

    /* Contribution to overall volume (auto+rule) */
    {
      "type": "metric", "x": 6, "y": 25, "width": 6, "height": 6,
      "properties": {
        "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300,
        "title": "Contribution to overall volume (auto + rule, %)",
        "metrics": [
          [ "Custom/APM", "IngestedBytes", { "id": "tot", "visible": false } ],
          [ "Custom/APM", "IngestedBytes", "IngestionReason", "auto", { "id": "ha2", "visible": false } ],
          [ ".", ".", "IngestionReason", "rule", { "id": "hr2", "visible": false } ],
          [ { "expression": "100*(ha2+hr2)/tot", "label": "% of total", "id": "h_pct" } ]
        ]
      }
    },

    /* Contribution over time (auto+rule vs total) */
    {
      "type": "metric", "x": 12, "y": 25, "width": 12, "height": 6,
      "properties": {
        "region": "us-east-1", "view": "timeSeries", "stat": "Sum", "period": 300,
        "title": "Contribution over time (auto + rule, %)",
        "metrics": [
          [ "Custom/APM", "IngestedBytes", "IngestionReason", "auto", { "id": "ha3", "visible": false } ],
          [ ".", ".", "IngestionReason", "rule", { "id": "hr3", "visible": false } ],
          [ "Custom/APM", "IngestedBytes", { "id": "t3", "visible": false } ],
          [ { "expression": "100*(ha3+hr3)/t3", "label": "auto+rule %" } ]
        ]
      }
    },

    /* ======= PER-REASON KPI TILES (auto, rule, manual, error, rare, analytics, synthetics, synthetics-browser, rum, xray, lambda, appsec) ======= */
    { "type": "text", "x": 0, "y": 31, "width": 24, "height": 2,
      "properties": { "markdown": "## Per-Reason KPIs (span volume and % of total)" } },

    /* We render tiles in rows of six for compactness */
    /* Row 1: auto, rule, manual, error, rare, analytics */
    { "type": "metric", "x": 0, "y": 33, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "Auto: Span volume",
        "metrics": [ [ "Custom/APM", "IngestedBytes", "IngestionReason", "auto" ] ] } },
    { "type": "metric", "x": 4, "y": 33, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "Auto: % of total",
        "metrics": [
          [ "Custom/APM", "IngestedBytes", "IngestionReason", "auto", { "id": "aa", "visible": false } ],
          [ "Custom/APM", "IngestedBytes", { "id": "tt", "visible": false } ],
          [ { "expression": "100*aa/tt", "label": "Auto %" } ]
        ] } },
    { "type": "metric", "x": 8, "y": 33, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "Rule: Span volume",
        "metrics": [ [ "Custom/APM", "IngestedBytes", "IngestionReason", "rule" ] ] } },
    { "type": "metric", "x": 12, "y": 33, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "Rule: % of total",
        "metrics": [
          [ "Custom/APM", "IngestedBytes", "IngestionReason", "rule", { "id": "rrp", "visible": false } ],
          [ "Custom/APM", "IngestedBytes", { "id": "ttp", "visible": false } ],
          [ { "expression": "100*rrp/ttp", "label": "Rule %" } ]
        ] } },
    { "type": "metric", "x": 16, "y": 33, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "Manual: Span volume",
        "metrics": [ [ "Custom/APM", "IngestedBytes", "IngestionReason", "manual" ] ] } },
    { "type": "metric", "x": 20, "y": 33, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "Manual: % of total",
        "metrics": [
          [ "Custom/APM", "IngestedBytes", "IngestionReason", "manual", { "id": "mp", "visible": false } ],
          [ "Custom/APM", "IngestedBytes", { "id": "ttp2", "visible": false } ],
          [ { "expression": "100*mp/ttp2", "label": "Manual %" } ]
        ] } },

    /* Row 2: error, rare, analytics, synthetics, synthetics-browser, rum */
    { "type": "metric", "x": 0, "y": 38, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "Error: Span volume",
        "metrics": [ [ "Custom/APM", "IngestedBytes", "IngestionReason", "error" ] ] } },
    { "type": "metric", "x": 4, "y": 38, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "Error: % of total",
        "metrics": [
          [ "Custom/APM", "IngestedBytes", "IngestionReason", "error", { "id": "ep", "visible": false } ],
          [ "Custom/APM", "IngestedBytes", { "id": "tt3", "visible": false } ],
          [ { "expression": "100*ep/tt3", "label": "Error %" } ]
        ] } },
    { "type": "metric", "x": 8, "y": 38, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "Rare: Span volume",
        "metrics": [ [ "Custom/APM", "IngestedBytes", "IngestionReason", "rare" ] ] } },
    { "type": "metric", "x": 12, "y": 38, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "Rare: % of total",
        "metrics": [
          [ "Custom/APM", "IngestedBytes", "IngestionReason", "rare", { "id": "rp2", "visible": false } ],
          [ "Custom/APM", "IngestedBytes", { "id": "tt4", "visible": false } ],
          [ { "expression": "100*rp2/tt4", "label": "Rare %" } ]
        ] } },
    { "type": "metric", "x": 16, "y": 38, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "Analytics: Span volume",
        "metrics": [ [ "Custom/APM", "IngestedBytes", "IngestionReason", "analytics" ] ] } },
    { "type": "metric", "x": 20, "y": 38, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "Analytics: % of total",
        "metrics": [
          [ "Custom/APM", "IngestedBytes", "IngestionReason", "analytics", { "id": "ap2", "visible": false } ],
          [ "Custom/APM", "IngestedBytes", { "id": "tt5", "visible": false } ],
          [ { "expression": "100*ap2/tt5", "label": "Analytics %" } ]
        ] } },

    /* Row 3: synthetics, synthetics-browser, rum, xray, lambda, appsec */
    { "type": "metric", "x": 0, "y": 43, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "Synthetics: Span volume",
        "metrics": [ [ "Custom/APM", "IngestedBytes", "IngestionReason", "synthetics" ] ] } },
    { "type": "metric", "x": 4, "y": 43, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "Synthetics: % of total",
        "metrics": [
          [ "Custom/APM", "IngestedBytes", "IngestionReason", "synthetics", { "id": "sp2", "visible": false } ],
          [ "Custom/APM", "IngestedBytes", { "id": "tt6", "visible": false } ],
          [ { "expression": "100*sp2/tt6", "label": "Synthetics %" } ]
        ] } },
    { "type": "metric", "x": 8, "y": 43, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "Synthetics-browser: Span volume",
        "metrics": [ [ "Custom/APM", "IngestedBytes", "IngestionReason", "synthetics-browser" ] ] } },
    { "type": "metric", "x": 12, "y": 43, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "Synthetics-browser: % of total",
        "metrics": [
          [ "Custom/APM", "IngestedBytes", "IngestionReason", "synthetics-browser", { "id": "sbp2", "visible": false } ],
          [ "Custom/APM", "IngestedBytes", { "id": "tt7", "visible": false } ],
          [ { "expression": "100*sbp2/tt7", "label": "Synthetics-browser %" } ]
        ] } },
    { "type": "metric", "x": 16, "y": 43, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "RUM: Span volume",
        "metrics": [ [ "Custom/APM", "IngestedBytes", "IngestionReason", "rum" ] ] } },
    { "type": "metric", "x": 20, "y": 43, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "RUM: % of total",
        "metrics": [
          [ "Custom/APM", "IngestedBytes", "IngestionReason", "rum", { "id": "rup2", "visible": false } ],
          [ "Custom/APM", "IngestedBytes", { "id": "tt8", "visible": false } ],
          [ { "expression": "100*rup2/tt8", "label": "RUM %" } ]
        ] } },

    { "type": "metric", "x": 0, "y": 48, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "X-Ray: Span volume",
        "metrics": [ [ "Custom/APM", "IngestedBytes", "IngestionReason", "xray" ] ] } },
    { "type": "metric", "x": 4, "y": 48, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "X-Ray: % of total",
        "metrics": [
          [ "Custom/APM", "IngestedBytes", "IngestionReason", "xray", { "id": "xrp2", "visible": false } ],
          [ "Custom/APM", "IngestedBytes", { "id": "tt9", "visible": false } ],
          [ { "expression": "100*xrp2/tt9", "label": "X-Ray %" } ]
        ] } },
    { "type": "metric", "x": 8, "y": 48, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "Lambda: Span volume",
        "metrics": [ [ "Custom/APM", "IngestedBytes", "IngestionReason", "lambda" ] ] } },
    { "type": "metric", "x": 12, "y": 48, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "Lambda: % of total",
        "metrics": [
          [ "Custom/APM", "IngestedBytes", "IngestionReason", "lambda", { "id": "lp2", "visible": false } ],
          [ "Custom/APM", "IngestedBytes", { "id": "tt10", "visible": false } ],
          [ { "expression": "100*lp2/tt10", "label": "Lambda %" } ]
        ] } },
    { "type": "metric", "x": 16, "y": 48, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "AppSec: Span volume",
        "metrics": [ [ "Custom/APM", "IngestedBytes", "IngestionReason", "appsec" ] ] } },
    { "type": "metric", "x": 20, "y": 48, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "AppSec: % of total",
        "metrics": [
          [ "Custom/APM", "IngestedBytes", "IngestionReason", "appsec", { "id": "appp2", "visible": false } ],
          [ "Custom/APM", "IngestedBytes", { "id": "tt11", "visible": false } ],
          [ { "expression": "100*appp2/tt11", "label": "AppSec %" } ]
        ] } },

    /* Unknown reason */
    { "type": "metric", "x": 0, "y": 53, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "Unknown: Span volume",
        "metrics": [ [ "Custom/APM", "IngestedBytes", "IngestionReason", "unknown" ] ] } },
    { "type": "metric", "x": 4, "y": 53, "width": 4, "height": 5,
      "properties": { "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300, "title": "Unknown: % of total",
        "metrics": [
          [ "Custom/APM", "IngestedBytes", "IngestionReason", "unknown", { "id": "unp2", "visible": false } ],
          [ "Custom/APM", "IngestedBytes", { "id": "tt12", "visible": false } ],
          [ { "expression": "100*unp2/tt12", "label": "Unknown %" } ]
        ] } },

    /* ======= RICH NOTES (as text widgets) ======= */
    { "type": "text", "x": 8, "y": 53, "width": 16, "height": 6,
      "properties": { "markdown": "### Head-based sampling (auto/rule)\nThe decision to keep/drop is taken on the root span and propagated downstream. A higher sampling rate yields more complete traces.\n\n### Error Traces (ingestion_reason:error)\nAgent collects error spans (up to implementation limits) to ensure visibility on failures.\n\n### Rare Traces (ingestion_reason:rare)\nCaptures low-traffic uniqueness across service/name/resource/status/error.type to maintain system coverage.\n\n### App Analytics\nDeprecated in Datadog; prefer head-based sampling." } },

    /* ======= CHANGE VS PRIOR WINDOW (MoM surrogate) ======= */
    { "type": "text", "x": 0, "y": 58, "width": 24, "height": 3,
      "properties": { "markdown": "## Change vs Prior Window (use dashboard time selector)\nSet time to *Last 4 weeks* for **Current** row. Then duplicate the view in a new browser tab with *Previous 4 weeks* to compare. CloudWatch has no calendar_shift metric math." } },

    { "type": "metric", "x": 0, "y": 61, "width": 12, "height": 7,
      "properties": {
        "region": "us-east-1", "view": "singleValue", "stat": "Sum", "period": 300,
        "title": "CURRENT WINDOW: Ingested Bytes by Reason (topline)",
        "metrics": [
          [ "Custom/APM", "IngestedBytes", "IngestionReason", "auto" ],
          [ ".", ".", "IngestionReason", "rule" ],
          [ ".", ".", "IngestionReason", "manual" ],
          [ ".", ".", "IngestionReason", "error" ],
          [ ".", ".", "IngestionReason", "rare" ],
          [ ".", ".", "IngestionReason", "analytics" ],
          [ ".", ".", "IngestionReason", "synthetics" ],
          [ ".", ".", "IngestionReason", "synthetics-browser" ],
          [ ".", ".", "IngestionReason", "rum" ],
          [ ".", ".", "IngestionReason", "xray" ],
          [ ".", ".", "IngestionReason", "lambda" ],
          [ ".", ".", "IngestionReason", "appsec" ],
          [ ".", ".", "IngestionReason", "unknown" ]
        ]
      }
    },

    { "type": "metric", "x": 12, "y": 61, "width": 12, "height": 7,
      "properties": {
        "region": "us-east-1", "view": "timeSeries", "stat": "Sum", "period": 300, "stacked": true,
        "title": "CURRENT WINDOW: Ingested Bytes by Reason (stacked series)",
        "metrics": [
          [ "Custom/APM", "IngestedBytes", "IngestionReason", "auto" ],
          [ ".", ".", "IngestionReason", "rule" ],
          [ ".", ".", "IngestionReason", "manual" ],
          [ ".", ".", "IngestionReason", "error" ],
          [ ".", ".", "IngestionReason", "rare" ],
          [ ".", ".", "IngestionReason", "analytics" ],
          [ ".", ".", "IngestionReason", "synthetics" ],
          [ ".", ".", "IngestionReason", "synthetics-browser" ],
          [ ".", ".", "IngestionReason", "rum" ],
          [ ".", ".", "IngestionReason", "xray" ],
          [ ".", ".", "IngestionReason", "lambda" ],
          [ ".", ".", "IngestionReason", "appsec" ],
          [ ".", ".", "IngestionReason", "unknown" ]
        ]
      }
    }
  ]
}
JSON
