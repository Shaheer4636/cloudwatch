# 1) Set range & context
REGION=us-east-1
ENV_DIM=nonprod
SERVICE_DIM=checkout
START=$(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%SZ)
END=$(date -u +%Y-%m-%dT%H:%M:%SZ)

# 2) Write metric queries to a file (no weird quoting)
cat > queries.json <<JSON
[
  { "Id":"auto",  "Label":"auto",
    "MetricStat":{ "Metric":{
        "Namespace":"APM/TraceIngestion","MetricName":"IngestedBytes",
        "Dimensions":[
          {"Name":"Env","Value":"$ENV_DIM"},
          {"Name":"Service","Value":"$SERVICE_DIM"},
          {"Name":"IngestionReason","Value":"auto"}
        ]},
      "Period":300,"Stat":"Sum"}},

  { "Id":"rule",  "Label":"rule",
    "MetricStat":{ "Metric":{
        "Namespace":"APM/TraceIngestion","MetricName":"IngestedBytes",
        "Dimensions":[
          {"Name":"Env","Value":"$ENV_DIM"},
          {"Name":"Service","Value":"$SERVICE_DIM"},
          {"Name":"IngestionReason","Value":"rule"}
        ]},
      "Period":300,"Stat":"Sum"}},

  { "Id":"manual","Label":"manual",
    "MetricStat":{ "Metric":{
        "Namespace":"APM/TraceIngestion","MetricName":"IngestedBytes",
        "Dimensions":[
          {"Name":"Env","Value":"$ENV_DIM"},
          {"Name":"Service","Value":"$SERVICE_DIM"},
          {"Name":"IngestionReason","Value":"manual"}
        ]},
      "Period":300,"Stat":"Sum"}},

  { "Id":"error","Label":"error",
    "MetricStat":{ "Metric":{
        "Namespace":"APM/TraceIngestion","MetricName":"IngestedBytes",
        "Dimensions":[
          {"Name":"Env","Value":"$ENV_DIM"},
          {"Name":"Service","Value":"$SERVICE_DIM"},
          {"Name":"IngestionReason","Value":"error"}
        ]},
      "Period":300,"Stat":"Sum"}},

  { "Id":"rare","Label":"rare",
    "MetricStat":{ "Metric":{
        "Namespace":"APM/TraceIngestion","MetricName":"IngestedBytes",
        "Dimensions":[
          {"Name":"Env","Value":"$ENV_DIM"},
          {"Name":"Service","Value":"$SERVICE_DIM"},
          {"Name":"IngestionReason","Value":"rare"}
        ]},
      "Period":300,"Stat":"Sum"}},

  { "Id":"analytics","Label":"analytics",
    "MetricStat":{ "Metric":{
        "Namespace":"APM/TraceIngestion","MetricName":"IngestedBytes",
        "Dimensions":[
          {"Name":"Env","Value":"$ENV_DIM"},
          {"Name":"Service","Value":"$SERVICE_DIM"},
          {"Name":"IngestionReason","Value":"analytics"}
        ]},
      "Period":300,"Stat":"Sum"}},

  { "Id":"synth","Label":"synthetics",
    "MetricStat":{ "Metric":{
        "Namespace":"APM/TraceIngestion","MetricName":"IngestedBytes",
        "Dimensions":[
          {"Name":"Env","Value":"$ENV_DIM"},
          {"Name":"Service","Value":"$SERVICE_DIM"},
          {"Name":"IngestionReason","Value":"synthetics"}
        ]},
      "Period":300,"Stat":"Sum"}},

  { "Id":"synthbrowser","Label":"synthetics-browser",
    "MetricStat":{ "Metric":{
        "Namespace":"APM/TraceIngestion","MetricName":"IngestedBytes",
        "Dimensions":[
          {"Name":"Env","Value":"$ENV_DIM"},
          {"Name":"Service","Value":"$SERVICE_DIM"},
          {"Name":"IngestionReason","Value":"synthetics-browser"}
        ]},
      "Period":300,"Stat":"Sum"}},

  { "Id":"rum","Label":"rum",
    "MetricStat":{ "Metric":{
        "Namespace":"APM/TraceIngestion","MetricName":"IngestedBytes",
        "Dimensions":[
          {"Name":"Env","Value":"$ENV_DIM"},
          {"Name":"Service","Value":"$SERVICE_DIM"},
          {"Name":"IngestionReason","Value":"rum"}
        ]},
      "Period":300,"Stat":"Sum"}},

  { "Id":"lambda","Label":"lambda",
    "MetricStat":{ "Metric":{
        "Namespace":"APM/TraceIngestion","MetricName":"IngestedBytes",
        "Dimensions":[
          {"Name":"Env","Value":"$ENV_DIM"},
          {"Name":"Service","Value":"$SERVICE_DIM"},
          {"Name":"IngestionReason","Value":"lambda"}
        ]},
      "Period":300,"Stat":"Sum"}},

  { "Id":"xray","Label":"xray",
    "MetricStat":{ "Metric":{
        "Namespace":"APM/TraceIngestion","MetricName":"IngestedBytes",
        "Dimensions":[
          {"Name":"Env","Value":"$ENV_DIM"},
          {"Name":"Service","Value":"$SERVICE_DIM"},
          {"Name":"IngestionReason","Value":"xray"}
        ]},
      "Period":300,"Stat":"Sum"}},

  { "Id":"appsec","Label":"appsec",
    "MetricStat":{ "Metric":{
        "Namespace":"APM/TraceIngestion","MetricName":"IngestedBytes",
        "Dimensions":[
          {"Name":"Env","Value":"$ENV_DIM"},
          {"Name":"Service","Value":"$SERVICE_DIM"},
          {"Name":"IngestionReason","Value":"appsec"}
        ]},
      "Period":300,"Stat":"Sum"}},

  { "Id":"unknown","Label":"unknown",
    "MetricStat":{ "Metric":{
        "Namespace":"APM/TraceIngestion","MetricName":"IngestedBytes",
        "Dimensions":[
          {"Name":"Env","Value":"$ENV_DIM"},
          {"Name":"Service","Value":"$SERVICE_DIM"},
          {"Name":"IngestionReason","Value":"unknown"}
        ]},
      "Period":300,"Stat":"Sum"}},

  { "Id":"totalbytes", "Label":"Total IngestedBytes (all reasons)",
    "Expression":"auto+rule+manual+error+rare+analytics+synth+synthbrowser+rum+lambda+xray+appsec+unknown" },

  { "Id":"headbytes", "Label":"Head-based (auto+rule)", "Expression":"auto + rule" },

  { "Id":"headpct", "Label":"Head-based % of total",
    "Expression":"100 * headbytes / MAX([totalbytes])" }
]
JSON

# 3) Call GetMetricData using the file
aws cloudwatch get-metric-data \
  --region "$REGION" \
  --start-time "$START" \
  --end-time "$END" \
  --metric-data-queries file://queries.json
