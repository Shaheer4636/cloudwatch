REGION=us-east-1

aws cloudwatch get-metric-data \
  --region "$REGION" \
  --start-time "$(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%SZ)" \
  --end-time   "$(date -u                +%Y-%m-%dT%H:%M:%SZ)" \
  --metric-data-queries '[
    {
      "Id":"totalbytes",
      "Expression":"SUM(SEARCH(\'{APM/TraceIngestion,IngestedBytes}\', \'Sum\', 300))",
      "Label":"Total IngestedBytes (all reasons)"
    },
    {
      "Id":"auto_only",
      "Expression":"SUM(SEARCH(\'{APM/TraceIngestion,IngestedBytes,IngestionReason=\"auto\"}\', \'Sum\', 300))",
      "Label":"auto"
    },
    {
      "Id":"rule_only",
      "Expression":"SUM(SEARCH(\'{APM/TraceIngestion,IngestedBytes,IngestionReason=\"rule\"}\', \'Sum\', 300))",
      "Label":"rule"
    },
    {
      "Id":"headbytes",
      "Expression":"auto_only + rule_only",
      "Label":"Head-based (auto+rule)"
    },
    {
      "Id":"headpct",
      "Expression":"100 * headbytes / MAX([totalbytes])",
      "Label":"Head-based % of total"
    }
  ]'
